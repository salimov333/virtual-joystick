<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Virtual Joystick</title>
    <style>
      :root {
        --ball-width: 50px;
        --joystick-width: 130px;
        --control-ball-width: 40px;
      }

      body {
        margin: 0;
        display: flex;
        justify-content: center;
        align-items: center;
        min-height: 100vh;
        overflow: hidden;
        background-color: #f0f0f0;
      }

      #gameArea {
        display: flex;
        flex-direction: column;
        width: 80vw;
        height: 80vh;
        background-color: #000;
        border-radius: 30px;
        overflow: hidden;
      }

      #moveArea {
        position: relative;
        flex: 7; /* 70% of the game area */
        background-color: #282828;
      }

      #circle {
        position: absolute;
        width: var(--ball-width);
        height: var(--ball-width);
        background-color: red;
        border-radius: 50%;
        transition: 0.3s linear;
        transform: translate(-50%, -50%);
      }

      #controlArea {
        flex: 3; /* 30% of the game area */
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(0, 0, 0, 0.1);
        position: relative;
      }

      #joystick {
        width: var(--joystick-width);
        height: var(--joystick-width);
        background-color: rgba(0, 0, 0, 0.2);
        border: 2px solid #333;
        border-radius: 50%;
        display: flex;
        justify-content: center;
        align-items: center;
        position: relative;
      }

      #controlBall {
        width: var(--control-ball-width);
        height: var(--control-ball-width);
        background-color: gray;
        border-radius: 50%;
        position: absolute; /* Make it position absolute to move freely within joystick */
      }

      /* Keyboard joystick styles */
      #keyboardJoystick {
        width: var(--joystick-width);
        height: var(--joystick-width);
        background-color: rgba(0, 0, 0, 0.2);
        border: 2px solid #333;
        border-radius: 50%;
        position: relative;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      /* Arrow icon styles */
      .arrow {
        width: 20px;
        height: 20px;
        background-color: transparent;
        position: absolute;
        font-size: 50px;
        color: white;
        display: flex;
        justify-content: center;
        align-items: center;
      }

      .arrow.up {
        top: 15%;
        left: 50%;
        transform: translate(-50%, -100%);
      }
      .arrow.down {
        bottom: 15%;
        left: 50%;
        transform: translate(-50%, 100%);
      }
      .arrow.left {
        left: 15%;
        top: 50%;
        transform: translate(-100%, -50%);
      }
      .arrow.right {
        right: 15%;
        top: 50%;
        transform: translate(100%, -50%);
      }
    </style>
  </head>
  <body>
    <div id="gameArea">
      <div id="moveArea">
        <div id="circle"></div>
      </div>
      <div id="controlArea">
        <div id="joystick" style="display: none">
          <div id="controlBall"></div>
        </div>
        <div id="keyboardJoystick" style="display: none">
          <div class="arrow up">↑</div>
          <div class="arrow down">↓</div>
          <div class="arrow left">←</div>
          <div class="arrow right">→</div>
        </div>
      </div>
    </div>

    <script>
      const moveArea = document.getElementById("moveArea");
      const circle = document.getElementById("circle");
      const controlArea = document.getElementById("controlArea");
      const joystick = document.getElementById("joystick");
      const controlBall = document.getElementById("controlBall");
      const keyboardJoystick = document.getElementById("keyboardJoystick");

      const rootStyles = getComputedStyle(document.documentElement);
      const ballWidth = parseFloat(rootStyles.getPropertyValue("--ball-width"));
      const joystickWidth = parseFloat(
        rootStyles.getPropertyValue("--joystick-width")
      );
      const controlBallWidth = parseFloat(
        rootStyles.getPropertyValue("--control-ball-width")
      );

      // Check for touch support
      const isTouchDevice = "ontouchstart" in window;

      // Show appropriate joystick based on device type
      if (isTouchDevice) {
        joystick.style.display = "flex";
      } else {
        keyboardJoystick.style.display = "flex";
      }

      // Center the circle by accounting for half its width/height
      let circleX = (moveArea.offsetWidth - ballWidth) / 2;
      let circleY = (moveArea.offsetHeight - ballWidth) / 2;
      const moveSpeed = 4; // Movement speed

      let dragging = false;
      let touchStartX, touchStartY;

      function updateCirclePosition() {
        circle.style.left = `${circleX + ballWidth / 2}px`;
        circle.style.top = `${circleY + ballWidth / 2}px`;
      }

      function constrainCircleToBounds() {
        circleX = Math.max(
          0,
          Math.min(circleX, moveArea.offsetWidth - ballWidth)
        );
        circleY = Math.max(
          0,
          Math.min(circleY, moveArea.offsetHeight - ballWidth)
        );
      }

      function isTouchInJoystick(touchX, touchY) {
        const rect = joystick.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        const radius = rect.width / 2;
        const distance = Math.sqrt(
          Math.pow(touchX - centerX, 2) + Math.pow(touchY - centerY, 2)
        );
        return distance <= radius;
      }

      function constrainControlBallToBounds(controlBallX, controlBallY) {
        const joystickRect = joystick.getBoundingClientRect();
        const centerX = joystickRect.width / 2;
        const centerY = joystickRect.height / 2;

        const distance = Math.sqrt(
          (controlBallX - centerX) ** 2 + (controlBallY - centerY) ** 2
        );
        if (distance > joystickRect.width / 2 - controlBallWidth / 2) {
          const angle = Math.atan2(
            controlBallY - centerY,
            controlBallX - centerX
          );
          controlBallX =
            centerX +
            (joystickRect.width / 2 - controlBallWidth / 2) * Math.cos(angle);
          controlBallY =
            centerY +
            (joystickRect.height / 2 - controlBallWidth / 2) * Math.sin(angle);
        }
        return { controlBallX, controlBallY };
      }

      // Touch controls
      if (isTouchDevice) {
        controlArea.addEventListener("touchstart", (e) => {
          const touch = e.touches[0];
          touchStartX = touch.clientX;
          touchStartY = touch.clientY;
          if (isTouchInJoystick(touchStartX, touchStartY)) {
            dragging = true;
          }
        });

        controlArea.addEventListener("touchmove", (e) => {
          if (!dragging) return;

          const touch = e.touches[0];
          const deltaX = touch.clientX - touchStartX;
          const deltaY = touch.clientY - touchStartY;

          const controlBallX = controlBall.offsetLeft + deltaX;
          const controlBallY = controlBall.offsetTop + deltaY;

          // Constrain the controlBall within the joystick
          const constrainedPosition = constrainControlBallToBounds(
            controlBallX + controlBallWidth / 2,
            controlBallY + controlBallWidth / 2
          );
          controlBall.style.left = `${
            constrainedPosition.controlBallX - controlBallWidth / 2
          }px`;
          controlBall.style.top = `${
            constrainedPosition.controlBallY - controlBallWidth / 2
          }px`;

          // Update circle position based on control ball movement
          circleX +=
            (constrainedPosition.controlBallX - joystick.offsetWidth / 2) *
            (moveSpeed / (joystickWidth / 2));
          circleY +=
            (constrainedPosition.controlBallY - joystick.offsetHeight / 2) *
            (moveSpeed / (joystickWidth / 2));

          constrainCircleToBounds();
          updateCirclePosition();

          touchStartX = touch.clientX;
          touchStartY = touch.clientY;
        });

        controlArea.addEventListener("touchend", () => {
          dragging = false;
          // Reset control ball to the center
          controlBall.style.left = `${
            (joystickWidth - controlBallWidth) / 2
          }px`;
          controlBall.style.top = `${(joystickWidth - controlBallWidth) / 2}px`;
        });
      } else {
        // Keyboard controls
        let keysPressed = {};

        document.addEventListener("keydown", (e) => {
          keysPressed[e.key] = true;
        });

        document.addEventListener("keyup", (e) => {
          keysPressed[e.key] = false;
        });

        function moveCircle() {
          if (keysPressed["ArrowUp"]) {
            circleY -= moveSpeed;
          }
          if (keysPressed["ArrowDown"]) {
            circleY += moveSpeed;
          }
          if (keysPressed["ArrowLeft"]) {
            circleX -= moveSpeed;
          }
          if (keysPressed["ArrowRight"]) {
            circleX += moveSpeed;
          }

          constrainCircleToBounds();
          updateCirclePosition();

          requestAnimationFrame(moveCircle);
        }

        requestAnimationFrame(moveCircle);
      }

      // Set the initial position of the circle and control ball
      updateCirclePosition();
      controlBall.style.left = `${(joystickWidth - controlBallWidth) / 2}px`;
      controlBall.style.top = `${(joystickWidth - controlBallWidth) / 2}px`;
    </script>
  </body>
</html>
